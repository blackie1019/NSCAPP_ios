<!DOCTYPE html>
<html lang="zh"><!-- manifest="cache.appcache" 開啟Cache 功能-->
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
        <!--ios-->
        <script type="text/javascript" src="js/ios/cordova-2.5.0.js"></script>
        <script type="text/javascript" src="js/ios/flurryPlugin.js"></script>
        <!--android-->
        <!--
         <script type="text/javascript" src="js/android/cordova-2.4.0.js"></script>
        -->
        <!--jQuery-->
        <script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
		<!--json2-->
		<script type="text/javascript" src="js/js.min/json2.min.js"></script>
		<!--Google Map API v3-->
		<!--<script type="text/javascript"	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDE9qxWxKreYH34oRyk2RCtM5-VqrauTPc&sensor=false"></script>-->
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
		<!--mobiScroll-->
		<script src="js/mobiscroll.core.js" type="text/javascript"></script>
		<script type="text/javascript" src="js/mobiscroll.select.js"></script>
		<link href="css/mobiscroll.custom-2.4.3.min.css" rel="stylesheet" type="text/css"></link>
		<script src="js/mobiscroll.custom.js" type="text/javascript"></script>
		<script>
		$(document).bind('mobileinit', function(){

		});
		</script>
		<!--<script src="http://debug.phonegap.com/target/target-script-min.js#blackie1019"></script>-->
		<!--jQuery mobile-->
        <link rel="stylesheet" type="text/css" href="css/jquery.mobile-NSC-1.3.0.css"></link>
        <script type="text/javascript" src="js/jquery.mobile-1.3.0.min.js"></script>
        <!--Plug in-->
        <script src="js/jquery.hammer.min.js"></script>
        <link rel="stylesheet" type="text/css" href="css/smoke.min.css">
        <!-- <link rel="stylesheet" type="text/css" href="css/smoke.theme.100s.css"> -->
        <script src="js/smoke.js"></script>
		<!--Hyweb CSS-->
		<link rel="stylesheet" type="text/css" href="css/index.css"></link>
		<!--HYAPP-->
		<!--NSCAPP Javascript-->	
		<script src="js/setting.js"></script>
		<script src="js/loading.js"></script> 
		<script src="js/pnpolygon.js"></script>
		<script src="js/photo.js"></script>	
		<script src="js/location.js"></script>	
		<script src="js/data.js"></script>
		<script src="js/map.js"></script>
	</head>
	<body>	
		<div data-role="page" id="LP">
		<script  type="text/javascript">
			document.addEventListener("deviceready",onDeviceReady,false);
			function onDeviceReady(){
				window.plugins.flurry.logEvent("[plugin]Page_NewsAndEvents.html");
			}
		</script>
		<script  type="text/javascript">
		/*global variables*/
		var langType=getAppSetting_Data().language,LP_jsonObjectArray=[],
			tmpTypeCode="",
			tmpCatalog="",
			tmpUnit="",
			tmpKeyWord="",
			tmpBeginDate="",
			tmpEndDate="",
			tmpOrderBys={"column":"createdTime","sortBy":"Desc"},
			tmpCount="100",
			tmpIndex="1";
		//function
		//更換相關顯示語言
		function loadDisplayLanguage(){
						//地圖模組
			var map_btnSearch_str,map_btnRoute_str,map_btnClassify1Filter_str,map_btnSetAlert_str,map_btnMAPShow_str,map_btnListShow_str,map_btnRoute_MAPShow_str,map_btnRoute_PathShow_str,map_labRoutePointStart_str,map_labRoutePointEnd_str,map_btnKeyWordSearch_str,map_txtSearchKeyWord_str;
			switch(langType){
				case "ch":
					map_btnSearch_str="搜尋地圖";
					map_btnRoute_str="規劃路徑";
					map_btnClassify1Filter_str="週邊生活服務";
					map_btnSetAlert_str="接近提醒";
					map_btnMAPShow_str="地圖呈現";
					map_btnListShow_str="圖文呈現";
					map_btnRoute_MAPShow_str="地圖導引";
					map_btnRoute_PathShow_str="文字導引";
					map_btnKeyWordSearch_str="查詢";
					map_txtSearchKeyWord_str="地址/地名/廠商名稱";
					map_labRoutePointStart_str="起點";
					map_labRoutePointEnd_str="終點";
					break;
				case "eng":
					map_btnSearch_str="Search Map";
					map_btnRoute_str="Directions";
					map_btnClassify1Filter_str="Nearby";	
					map_btnSetAlert_str="Notification";
					map_btnMAPShow_str="Map View";
					map_btnListShow_str="List View";
					map_btnRoute_MAPShow_str="Map";
					map_btnRoute_PathShow_str="Instructions";
					map_btnKeyWordSearch_str="Search";
					map_txtSearchKeyWord_str="Address、Companies";
					map_labRoutePointStart_str="Start";
					map_labRoutePointEnd_str="End";
					break;
			}
			$('#Map_LP #footer').find('#btnSearch').text(map_btnSearch_str);
			$('#Map_LP #footer').find('#btnRoute').text(map_btnRoute_str);
			$('#Map_LP #footer').find('#btnClassify1Filter').text(map_btnClassify1Filter_str);
			$('#Map_LP #footer').find('#btnSetAlert').text(map_btnSetAlert_str);
			$('#Map_LP #footer').find('#btnMAPShow').text(map_btnMAPShow_str);
			$('#Map_LP #footer').find('#btnListShow').text(map_btnListShow_str);
			$('#Map_LP #footer').find('#btnRoute_MAPShow').text(map_btnRoute_MAPShow_str);
			$('#Map_LP #footer').find('#btnRoute_PathShow').text(map_btnRoute_PathShow_str);


			$('#Map_LP #divKeyWordSearch').find("#btnKeyWordSearch").text(map_btnKeyWordSearch_str);
			$('#Map_LP #divKeyWordSearch').find("#txtSearchKeyWord").attr("placeholder",map_txtSearchKeyWord_str);

			$('#Map_LP #divRoutePath').find("#labRoutePointStart").text(map_labRoutePointStart_str);
			$('#Map_LP #divRoutePath').find("#labRoutePointEnd").text(map_labRoutePointEnd_str);
			$('#Map_LP #divRoutePath').find("#txtRoutePointStart").attr("placeholder",map_txtSearchKeyWord_str);
			$('#Map_LP #divRoutePath').find("#txtRoutePointEnd").attr("placeholder",map_txtSearchKeyWord_str);
			$('#Map_LP #divRoutePath').find("#btnDoRoute").text(map_btnRoute_str);
			$('#Map_LP #routeList').find("#divRouteHeader").text(map_btnRoute_str);
			$('#Map_LP #routeList').find("#divDirectionHeader").text(map_btnRoute_str);
		}
		function doRefresh(langType,typeCode,catalog,unit,keyWord,beginDate,endDate,orderBys,count,index){
		    LoadingObject.show();
		    if(catalog=="00"){
		    	catalog="";
		    }
		    if(unit=="00"){
		    	unit="";
		    }
			var jsonObject={"AppType":getAppType(),"typeCode":typeCode,"catalog":catalog,"unit":unit,"keyWord":keyWord,"dateRange":{"beginDate":beginDate,"endDate":endDate},"level":"2","count":count,"index":index};
			var jsonObjectStr = JSON.stringify(jsonObject);
			var htmlResult="";
			var park=getIdentifyParkBase().Park,nearAlertSpot=null,Target_Collapsible_Classify1_ID="",map;//地圖模組
			//假資料
			var DataURL=DataURL_NewsAndEvents_LP;
		    $.ajax({
		        url:DataURL,
		        data:  {"jsonInput":jsonObjectStr},
		        type:"POST",
		        dataType :"jsonp",
		        async:false,
		        success:function(data){
		            if(data==null){
		                 smoke.alert(ServiceCodeErrorString,{},function(){});
		            }else{
		                if(data.status=="success"){
		    				//產生上方類別
		    				genTopList(typeCode,data.jsonOutput.type);
							//產生下方分類下拉內容
							genCatalogList(data.jsonOutput.catalog);
							//產生下方發佈處室下拉內容
							genUnitList(data.jsonOutput.unit);
							//產生右上方查詢內容
							 genAdvSearch(data.jsonOutput.catalog,data.jsonOutput.unit);
							//產生條列內容
							for(var i=0;i<data.jsonOutput.items.length;i++){
		                		var Desc=data.jsonOutput.items[i].chtDesc.replace('color=#ff0000','');
		                		if(Desc.length>20){
		                			Desc=Desc.substr(0,40)+"...";
		                		}
		                		htmlResult+="<li data-typecode='"+data.jsonOutput.typeCode+"' data-sn='"+data.jsonOutput.items[i].SN+"''><h2>"+data.jsonOutput.items[i].chtTitle+"</h2><p>"+Desc+"</p><div class='floatleft'>"+data.jsonOutput.items[i].UnitName+"</div><div class='floatright'>"+data.jsonOutput.items[i].createdTime+"</div><div class='arrow'><img src='img/NSC/arrow.png' alt='arrow'></img></div></li>";
	            			}
	            			if(htmlResult==""){
	            				htmlResult+="查無資料";
	            			}
            				$('#LP').find('#htmlResult').html("<ul>"+htmlResult+"</ul>");
							//設定catalog active項目顏色
							$('#LP').find('#catalogList a[data-code="'+catalog+'"]').addClass('ui-btn-active');
							//設定unit active項目顏色
							$('#LP').find('#unitList a[data-code="'+unit+'"]').addClass('ui-btn-active');
							$('#LP').trigger('create');
		                }else{
		                    smoke.alert(ServiceCodeErrorString,{},function(){});
		                }
		            }
		        },
		        error: function(data){
		            LoadingObject.hide(); 
		            smoke.alert(ServiceErrorString,{},function(){});
		        },
		        complete: function() {
		            LoadingObject.hide();
		        }
		    });
		}
		function changeToCP(typeCode,sn){
		    LoadingObject.show();
			var jsonObject={"AppType":getAppType(),"typeCode":typeCode,"SN":sn};
			var jsonObjectStr = JSON.stringify(jsonObject);
			var htmlResult="";
		    $.ajax({
		        url:DataURL_NewsAndEvents_CP,
		        data:  {"jsonInput":jsonObjectStr},
		        type:"POST",
		        dataType :"json",
		        async:false,
		        success:function(data){
		            if(data==null){
		                 smoke.alert(ServiceCodeErrorString,{},function(){});
		            }else{
		                if(data.status=="success"){
		                	if(data.jsonOutput!=null){
		                		htmlResult+="<div class='int'><div class='title'>"+data.jsonOutput.title+"</div><p>"+data.jsonOutput.HTML+"</p></div>";
	            				$('#CP').find('#htmlResult').html(htmlResult).trigger('refresh');
	            				$.mobile.changePage('#CP');
	            			}else{
	            				smoke.alert(ServiceCodeErrorString,{},function(){});
	            			}
		                }else{
		                    smoke.alert(ServiceCodeErrorString,{},function(){});
		                }
		            }
		        },
		        error: function(data){
		            LoadingObject.hide(); 
		            smoke.alert(ServiceErrorString,{},function(){});
		        },
		        complete: function() {
		            LoadingObject.hide();
		        }
		    });
		}
		function setType(typeCode){
			tmpTypeCode=typeCode;
			//還原預設
			langType="ch",
			tmpCatalog="",
			tmpUnit="",
			tmpKeyWord="",
			tmpBeginDate="",
			tmpEndDate="",
			tmpOrderBys={"column":"createdTime","sortBy":"Desc"},
			tmpCount="100",
			tmpIndex="1";
			//條列呈現
			doRefresh(langType,tmpTypeCode,tmpCatalog,tmpUnit,tmpKeyWord,tmpBeginDate,tmpEndDate,tmpOrderBys,tmpCount,tmpIndex);
		}
		function genTopList(typeCode,items){
			var htmlResult="",focusIndex=0;
			for(var i=0;i<items.length;i++){
				if(typeCode==items[i].code){
					focusIndex=i;
				}
				htmlResult+='<li><a href="javascript:setType(&#39;'+items[i].code+'&#39;);">'+items[i].value+'</a></li>';
			}
			$('#LP').find('#sub-menu').html('<ul class="toplist" data-role="none">'+htmlResult+'</ul>').trigger('create');
			$('#LP').find('.toplist li a:eq('+focusIndex+')').addClass('hover');
			htmlResult=null;focusIndex=null;delete focusIndex;delete htmlResult;
		}
		function genCatalogList(items){
			var htmlResult='';
			for(var i=0;i<items.length;i++){
				htmlResult+='<a data-theme="c" data-code="'+items[i].code+'" href="javascript:setCatalog(&#39;'+items[i].code+'&#39;);" data-role="button"  >'+items[i].value+'</a>';
			}
			$('#LP').find('#catalogList').html(htmlResult).trigger('create');
			htmlResult=null;delete htmlResult;
		}
		function genUnitList(items){
			var htmlResult='<a data-theme="c" data-code="" href="javascript:setUnit();" data-role="button">全部</a>';
			for(var i=0;i<items.length;i++){
				htmlResult+='<a data-theme="c" data-code="'+items[i].value+'" href="javascript:setUnit(&#39;'+items[i].value+'&#39;);" data-role="button"  >'+items[i].value+'</a>';
			}
			$('#LP').find('#unitList').html(htmlResult).trigger('create');
			htmlResult=null;delete htmlResult;
		}
		function genAdvSearch(catalog,unit){
			var catalogHtmlResult='<option selected="selected" value="">全部</option>',unitHtmlResult='<option selected="selected" value="">全部</option>';
			for(var i=0;i<catalog.length;i++){
				catalogHtmlResult+="<option value='"+catalog[i].code+"'>"+catalog[i].value+"</option>";
			}
			for(var i=0;i<unit.length;i++){
				unitHtmlResult+="<option value='"+unit[i].code+"'>"+unit[i].value+"</option>";
			}
			$('#adv_catalog').html(catalogHtmlResult).selectmenu('refresh', true);
			$('#adv_unit').html(unitHtmlResult).selectmenu('refresh', true);
			catalogHtmlResult=null;unitHtmlResult=null;
			delete catalogHtmlResult;delete unitHtmlResult;
		}
		function setCatalog(catalog){
			if(typeof(catalog)!='undefined'){
				tmpCatalog=catalog;
			}else{
				tmpCatalog="";
			}
			//條列呈現
			doRefresh(langType,tmpTypeCode,tmpCatalog,tmpUnit,tmpKeyWord,tmpBeginDate,tmpEndDate,tmpOrderBys,tmpCount,tmpIndex);
			$('#popupDialog_catalog').popup('close');

		}
		function setUnit(unit){
			if(typeof(unit)!='undefined'){
				tmpUnit=unit;
			}else{
				tmpUnit="";
			}
			//條列呈現
			doRefresh(langType,tmpTypeCode,tmpCatalog,tmpUnit,tmpKeyWord,tmpBeginDate,tmpEndDate,tmpOrderBys,tmpCount,tmpIndex);
			$('#popupDialog_unit').popup('close');

		}
		function setKeyword(){
			tmpKeyWord=$('#popupDialog_titleSearch #search').val();
			$('#popupDialog_titleSearch').popup('close');
			//先清空
			$('#LP').find('#htmlResult').html("<ul></ul>");
			$('#LP').trigger('create');
			//條列呈現
			doRefresh(langType,tmpTypeCode,tmpCatalog,tmpUnit,tmpKeyWord,tmpBeginDate,tmpEndDate,tmpOrderBys,tmpCount,tmpIndex);
			$.mobile.changePage('#LP_temp');
		}
		function setDateRange(){
			console.log(123);
			var isRefresh=true;
			tmpBeginDate=$('#popupDialog_dateRange #beginDate').val().replace('-','/').replace('-','/');
			tmpEndDate=$('#popupDialog_dateRange #endDate').val().replace('-','/').replace('-','/');
			if(tmpBeginDate!=""&&tmpEndDate!=""&&tmpEndDate<tmpBeginDate){
				isRefresh=false;
				$('#popupDialog_dateRange').popup('close');
				smoke.alert("輸入的時間區間不正確",{},function(){});
			}
			if(isRefresh){
				$('#popupDialog_dateRange').popup('close');
				//條列呈現
				doRefresh(langType,tmpTypeCode,tmpCatalog,tmpUnit,tmpKeyWord,tmpBeginDate,tmpEndDate,tmpOrderBys,tmpCount,tmpIndex);
			}

		}
		function setAdvSearch(){
			var isRefresh=true;
			tmpKeyWord=$('#popupDialog_advSearch #search').val().replace('-','/').replace('-','/');
			tmpBeginDate=$('#popupDialog_advSearch #beginDate').val().replace('-','/').replace('-','/');
			tmpEndDate=$('#popupDialog_advSearch #endDate').val();
			if(tmpBeginDate!=""&&tmpEndDate!=""&&tmpEndDate<tmpBeginDate){
				isRefresh=false;
				$('#popupDialog_advSearch').popup('close');
				smoke.alert("輸入的時間區間不正確",{},function(){});
			}
			if(isRefresh){
				//條列呈現
				doRefresh(langType,tmpTypeCode,tmpCatalog,tmpUnit,tmpKeyWord,tmpBeginDate,tmpEndDate,tmpOrderBys,tmpCount,tmpIndex);
			}			
			
		}
		function iniControlSetting(){
			var today=new Date().toISOString().slice(0,10);
			$("input[type=date]").val(today);
			// $('#popupDialog_dateRange #beginDate').val(today);
			// $('#popupDialog_dateRange #endDate').val(today);
			// $('#popupDialog_advSearch #beginDate').val(today);
			// $('#popupDialog_advSearch #endDate').val(today);

		}
		//pageinit
		$(document).on('pageinit','#LP',function(){	
			//產生跑馬燈
			var jsonObject=getAppInstantMessage();
			if(jsonObject!=null){
				var title=jsonObject.title;
				genAppInstantMessage($('#content'),title);
			}
			//產生menu
			genMenu(this);
			//menu登入確認
			menuDisplayMemberSection(checkLogin(),this);
			// //手勢動作
			// $(this).on('swiperight',function(){
			// 	$( "#menu" ).panel( "toggle" );
			// });
			//控制項初始化設定
			iniControlSetting();
 			//條列呈現
 			doRefresh(langType,tmpTypeCode,tmpCatalog,tmpUnit,tmpKeyWord,tmpBeginDate,tmpEndDate,tmpOrderBys,tmpCount,tmpIndex);
			//更換相關顯示語言
			loadDisplayLanguage();
			//條列個別點擊事件
 			$(this).find('#htmlResult').on('click','li',function(){
 				var sn=$(this).data("sn");
 				var typeCode=$(this).data("typecode");
 				changeToCP(typeCode,sn);
 				sn=null;typeCode=null;delete typeCode;delete sn;
 			});
 		});
 		$(document).on('pageshow','#LP',function(){	
	 		$('#LP').find('#footerTool').fixedtoolbar('updatePagePadding');
	 	});
 		$(document).on('pageshow','#LP_temp',function(){
 			//setDateRange();	
	 		$.mobile.changePage('#LP');
	 	});
		/*地圖模組*/
		/*Map function*/
		function doClassify1Filter(Collapsible_Classify1_ID,classify1,isAll){
			var classifyArray=[];
			if(typeof(isAll)!="undefined"&&isAll){
				var checkedList=$('#classify1List input[type=checkbox]');
				//取得classifyArray
				for(var i=0;i<checkedList.length;i++){
					$(checkedList[i]).attr('checked',true).checkboxradio("refresh");
					classifyArray.push({ "classify1":$(checkedList[i]).data('classify1'),"classify2":$(checkedList[i]).data('classify2')});
				}
			}else{
				if(Collapsible_Classify1_ID!=""){
					// var checkedList=$('#'+Collapsible_Classify1_ID+' input[type=checkbox]:checked');
					var checkedList=$('#classify1List input[type=checkbox]:checked');
					//取得classifyArray
					for(var i=0;i<checkedList.length;i++){
						classifyArray.push({ "classify1":$(checkedList[i]).data('classify1'),"classify2":$(checkedList[i]).data('classify2')});
					}
				}
			}
			if(classifyArray.length==0){
				$('#popupDialog_classify1Filter').popup('close');
				if(langType!="eng"){
					smoke.alert(classify2RequirementString,{ok:"確認"},function(){
						$('#popupDialog_classify1Filter').popup('open');
					});
				}else{
					smoke.alert(classify2RequirementString_eng,{ok:"ok"},function(){
						$('#popupDialog_classify1Filter').popup('open');
					});
				}
			}else{
				switchFooterFunction('default');
				LoadingObject.show();
				var jsonObject={
				  "queryType": "3",
				  "langType": langType,
				  "park": getIdentifyParkBase().Park,
				  "inner": getIsInArea(),
				  "currentLat": getGPRSData.lat,
				  "currentLng":getGPRSData.lng,
				  "LBSSpotClassifyArray":classifyArray
				};
				//如果有LBSCenterLatLng的值(lat,lng)，則改為目的點為querylat,querylng
				if(typeof(map.LBSCenterLatLng)!=="undefined"&&map.LBSCenterLatLng!=null){
					 jsonObject={
					  "queryType": "1",
					  "langType": langType,
					  "park": getIdentifyParkBase().Park,
					  "currentLat": getGPRSData.lat,
					  "currentLng":getGPRSData.lng,
					  "queryLat": map.LBSCenterLatLng.lat,
					  "queryLng": map.LBSCenterLatLng.lng,
	  				  "LBSSpotClassifyArray":classifyArray
					}
				}
				var jsonObjectStr = JSON.stringify(jsonObject);
			    $.ajax({
			        url:DataURL_LBSQueryService,
			        data:  {"jsonInput":jsonObjectStr},
			        type:"POST",
			        dataType :"json",
			        async:false,
			        success:function(data){
			            if(data==null){
			                 smoke.alert(ServiceCodeErrorString,{},function(){});
			            }else{
			            	LP_jsonObjectArray=[];
			                if(data.statusCode=="200"){
			                	if(data.spotList.length>0){
			                		for(var i=0;i<data.spotList.length;i++){
			                			LP_jsonObjectArray.push({"spotNo":data.spotList[i].spotNo,"chtName":data.spotList[i].name,"chtAddress":data.spotList[i].address,"xicon":Setting_classifyImgSrc+data.spotList[i].xicon,"ximage":Setting_imgSrc+data.spotList[i].mainImage,"latitude":data.spotList[i].latitude,"longitude":data.spotList[i].longitude,"classify1":data.spotList[i].classify1,"classify2":data.spotList[i].classify2,"classify2_name":data.spotList[i].classify2Name});
			                			// LP_jsonObjectArray.push({"spotNo":data.spotList[i].spotNo,"chtName":data.spotList[i].name,"chtAddress":data.spotList[i].address,"xicon":getXiconImg(data.spotList[i].classify2),"ximage":Setting_imgSrc+data.spotList[i].mainImage,"latitude":data.spotList[i].latitude,"longitude":data.spotList[i].longitude,"classify1":data.spotList[i].classify1,"classify2":data.spotList[i].classify2,"classify2_name":data.spotList[i].classify2Name});
		
				                	}
			            		}else{
			            			var alertMessage="查無資料";
			            			if(langType=="eng"){
			            				alertMessage="not find";
			            			}
			            			smoke.alert(alertMessage,{},function(){});
			            		}
	            				convertToGMAPMarkers();
	        					$('#popupDialog_classify1Filter').popup('close');
			                }else{
			                    smoke.alert(ServiceCodeErrorString,{},function(){});
			                }
			            }
			        },         
			        error: function(data){
			            LoadingObject.hide(); 
			            smoke.alert(ServiceErrorString,{},function(){});
			        },
			        complete: function() {
			            LoadingObject.hide();
			        }
			    });
			}
		}
		function doClassifyClear(){
			var checkedList=$('#classify1List input[type=checkbox]:checked');
			for(var i=0;i<checkedList.length;i++){
				$(checkedList[i]).attr('checked',false).checkboxradio("refresh");
			}
		}
		function genClassify1List(){
			 LoadingObject.show();
			var jsonObject={"langType":langType};
			var jsonObjectStr = JSON.stringify(jsonObject);
			var str_search="查詢",str_close="關閉",str_clear="清除",str_all="全部";
			if(langType!="ch"){
				str_search="Search";
				str_close="Close";
				str_clear="Clear";
				str_all="ALL";
			}
			var nowCode1="";
			//var classify1ListResult='<a data-theme="c" data-code="" href="javascript:doClassify1Filter(&#39;&#39;);" data-role="button">全部</a>';
			var classify1ListResult='<div style="text-align:right"><a class="popupCloseBtn" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" style="position:absolute;top: -5px;left:-10px;">'+str_close+'</a></div><div data-role="collapsible-set" data-theme="c" data-content-theme="c" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d"><div data-role="controlgroup" id="topFunc" data-type="horizontal"><a data-theme="c" data-code="" href="javascript:doClassify1Filter(&#39;&#39;,&#39;&#39;,true);" data-role="button">'+str_all+'</a><a data-theme="c" data-code="" href="javascript:doClassifyClear();" data-role="button">'+str_clear+'</a></div>'
		    $.ajax({
		        url:DataURL_Classify,
		        data:  {"jsonInput":jsonObjectStr},
		        type:"POST",
		        dataType :"jsonp",
		        async:false,
		        success:function(data){
		            if(data==null){
		                 smoke.alert(ServiceCodeErrorString,{},function(){});
		            }else{
		                if(data.status=="success"){
							for(var i=0;i<data.jsonOutput.length;i++){
								if(nowCode1!=data.jsonOutput[i].code1){
									if(nowCode1!=""){
										classify1ListResult+='</ul><button data-theme="e" onclick="doClassify1Filter(&#39;Collapsible_Classify1_'+nowCode1+'&#39;,&#39;'+nowCode1+'&#39;);"'+'>'+str_search+'</button>';
										classify1ListResult+='</div>';
									}
									classify1ListResult+='<div data-role="collapsible" id="Collapsible_Classify1_'+data.jsonOutput[i].code1+'" class="Collapsible_Classify1" data-inset="false">';
									classify1ListResult+='<h2>'+data.jsonOutput[i].name1+'</h2>';
									// classify1ListResult+='<ul data-role="listview">';
									nowCode1=data.jsonOutput[i].code1;
								}
								// classify1ListResult+='<li data-classify1="'+data.jsonOutput[i].code2+'" data-classify2="'+data.jsonOutput[i].code2+'">'+data.jsonOutput[i].name2+'</li>';
								classify1ListResult+='<input data-theme="f" data-classify1="'+data.jsonOutput[i].code1+'" data-classify2="'+data.jsonOutput[i].code2+'" type="checkbox" name="checkbox_classifyList" id="checkbox_classifyList_'+data.jsonOutput[i].code2+'"><label for="checkbox_classifyList_'+data.jsonOutput[i].code2+'">'+data.jsonOutput[i].name2+'</label>';
							}
							if(data.jsonOutput.length>0){
								classify1ListResult+='</ul><button data-theme="e" onclick="doClassify1Filter(&#39;Collapsible_Classify1_'+nowCode1+'&#39;,&#39;'+nowCode1+'&#39;);"'+'>'+str_search+'</button>';
								classify1ListResult+='</div>';
							}
							$('#Map_LP').find('#classify1List').html(classify1ListResult).trigger('create');
						}
						else{
		                    smoke.alert(ServiceCodeErrorString,{},function(){});
		                }
		            }
		        },
		        error: function(data){
		            LoadingObject.hide(); 
		            smoke.alert(ServiceErrorString,{},function(){});
		        },
		        complete: function() {
		            LoadingObject.hide();
		        }
		    });
		}
		function getClassifyArray(checkedList){
			var classifyArray=[];
			for(var i=0;i<checkedList.length;i++){
				classifyArray.push({ "classify1":checkedList[i].code1,"classify2":checkedList[i].code2});
			}
			return classifyArray;
		}
		function changeToMap_CP(sn){
		    LoadingObject.show();
		    var str_route="規劃路線",str_call="撥打電話",str_map="地圖";
		    if(langType=="eng"){
		    	str_route="Route";
		    	str_call="Call";
		    	str_map="Map";
		    }
			// var jsonObject={"command":"select xLBSSpot.spotNo,xLBSSpot.chtName,xLBSSpot.chtAddress,xLBSSpot.engName,xLBSSpot.engAddress,xLBSSpot.latitude,xLBSSpot.longitude,xLBSSpot.parkArea,xLBSSpot.parkLocation,(case xLBSSpotPic.ximage when '' then '' else ('"+Setting_imgSrc+"'+xLBSSpotPic .ximage)   end) as ximage,xLBSSpotClassify.xLBSClassify1,xLBSSpotClassify.xLBSClassify2,xLBSClassify2.chtName as xLBSClassify2_name, xLBSClassify2.engName as xLBSClassify2_ename,xLBSSpot.telTitle,xLBSSpot.telNumber,xLBSSpot.telEngTitle,xLBSSpot.urlTitle,xLBSSpot.urlAddress,xLBSSpot.urlEngTitle,xLBSSpot.chtDesc,xLBSSpot.engDesc from xLBSSpot inner join xLBSSpotClassify on xLBSSpot.spotNo=xLBSSpotClassify.spotNo inner join xLBSClassify2 on xLBSSpotClassify.xLBSClassify2=xLBSClassify2.code left join xLBSSpotPic on xLBSSpot.spotNo=xLBSSpotPic.spotNo where xLBSSpotPic.entranceCode is NULL and xLBSSpot.spotNo="+sn+" order by xLBSSpotClassify.xLBSClassify1,xLBSSpotClassify.xLBSClassify2,xLBSSpot.spotNo"};
			var jsonObject={
				"queryType": "2",
				"langType": langType,
				"park": getIdentifyParkBase().Park,
				"inner": getIsInArea(),
				"currentLat": getGPRSData.lat,
				"currentLng":getGPRSData.lng,
				"spotNo":sn
			}
			var jsonObjectStr = JSON.stringify(jsonObject);
			var htmlResult="",otherImagesArray=[];
			var str_addr="地址",str_desc="地點描述";
			if(langType=="eng"){
				str_addr="Address";
				str_desc="Description";
			}
		    $.ajax({
		        url:DataURL_LBSQueryService,
		        data:  {"jsonInput":jsonObjectStr},
		        type:"POST",
		        dataType :"json",
		        async:false,
		        success:function(data){
		            if(data==null){
		                 smoke.alert(ServiceCodeErrorString,{},function(){});
		            }else{
		                if(data.statusCode=="200"||data.statusCode=="201"){
		                	if(data.spotList.length>0){
								//生活服務內容
		                		htmlResult+="<div class='ServiceCt'><div class='title'>"+data.spotList[0].name+"</div><ul class='photo'>";
		                		if(data.spotList[0].mainImage!=""){
		                			htmlResult+="<li class='here' ><img src='"+Setting_imgSrc+data.spotList[0].mainImage+"'></li>";
		                		}
		                		if(data.spotList[0].otherImages!=""){
			                		otherImagesArray=data.spotList[0].otherImages.split(',');
			                	}
		                		//等ken處理
		                		for(var i=0;i<otherImagesArray.length;i++){

		                			htmlResult+="<li";
		                			htmlResult+="><img src='"+Setting_imgSrc+otherImagesArray+"'></li>";
		                		}
		                		htmlResult+="</ul><ul class='info'>";
		                		if(typeof(data.spotList[0].address)!="undefined"&&data.spotList[0].address!=""){
	            					htmlResult+="<li>"+str_addr+":"+(typeof(data.spotList[0].address)=="undefined"?"":data.spotList[0].address)+"</li>";
	            				}
	            				if(typeof(data.spotList[0].telNumber)!="undefined"&&data.spotList[0].telNumber!=""){
		        					htmlResult+="<li>"+(typeof(data.spotList[0].telTitle)=="undefined"?"電話：":data.spotList[0].telTitle+"：")+(typeof(data.spotList[0].telNumber)=="undefined"?"":data.spotList[0].telNumber)+"</li>";
		        				}
		        				if(typeof(data.spotList[0].urlAddress)!="undefined"&&data.spotList[0].urlAddress!=""){
		        					htmlResult+="<li>"+((typeof(data.spotList[0].urlTitle)=="undefined"||data.spotList[0].urlTitle=="")?"網址：":data.spotList[0].urlTitle+"：")+"<a href='javascript:openBrowser(&#39;"+data.spotList[0].urlAddress+"&#39;);' >"+((typeof(data.spotList[0].urlAddress)=="undefined"||data.spotList[0].urlAddress=="http://")?"":data.spotList[0].urlAddress)+"</a></li>";
		        				}
		        				if(typeof(data.spotList[0].description)!="undefined"&&data.spotList[0].description!=""){
		        					htmlResult+="<li>"+str_desc+":"+data.spotList[0].description+"</li>";
		        				}
		                		htmlResult+="</ul></div>";
								//功能列
								htmlResult+="<div class='springboard2'><ul><li>"+
											"<button data-role='none' id='btnMap' data-xicon='"+Setting_classifyImgSrc+data.spotList[0].xicon+"' data-ximage='"+Setting_imgSrc+data.spotList[0].mainImage+"' data-title='"+data.spotList[0].name+"' data-latitude='"+data.spotList[0].latitude+"' data-longitude='"+data.spotList[0].longitude+"' data-spotno='"+data.spotList[0].spotNo+"' data-address='"+data.spotList[0].address+"' class='map'>"+str_map+"</button>"+
											"<button data-role='none' id='btnRoute' data-xicon='"+Setting_classifyImgSrc+data.spotList[0].xicon+"' data-ximage='"+Setting_imgSrc+data.spotList[0].mainImage+"' data-title='"+data.spotList[0].name+"' data-latitude='"+data.spotList[0].latitude+"' data-longitude='"+data.spotList[0].longitude+"' data-spotno='"+data.spotList[0].spotNo+"' data-address='"+data.spotList[0].address+"'  class='route'>"+str_route+"</button>"+
											"<button data-role='none' id='btnTel' data-tel='"+data.spotList[0].telNumber+"'  class='tel'>"+str_call+"</button>"+
											"</li></ul></div>";
		   					}else{
		            			var alertMessage="查無資料";
		            			if(langType=="eng"){
		            				alertMessage="not find";
		            			}
		            			smoke.alert(alertMessage,{},function(){});
		            		}
	        				$('#Map_CP').find('#content').html(htmlResult); 
	        				$.mobile.changePage('#Map_CP');
		                }else{
		                    smoke.alert(ServiceCodeErrorString,{},function(){});
		                }
		            }
		        },
		        error: function(data){
		            LoadingObject.hide(); 
		            smoke.alert(ServiceErrorString,{},function(){});
		        },
		        complete: function() {
		            LoadingObject.hide();
		        }
		    });
		}
		function switchRouteShowType(type){
			if(type=='path'){
				$('#routeList').show();
				$('#map_canvas').hide();
				$('#Map_LP').find('#btnRoute_MAPShow').removeClass('listbtn03').addClass('listbtn01');
				$('#Map_LP').find('#btnRoute_PathShow').removeClass('listbtn04').addClass('listbtn02');
			}else{
				$('#routeList').hide();
				$('#map_canvas').show();
				$('#Map_LP').find('#btnRoute_MAPShow').removeClass('listbtn01').addClass('listbtn03');
				$('#Map_LP').find('#btnRoute_PathShow').removeClass('listbtn02').addClass('listbtn04');
				//重整地圖尺寸跟地圖調整中心	
				map.refresh();
			}
		}
		function switchLPShowType(type){
			$('#routeList').hide();
			var htmlResult="";
			var nowClassify2="";
			var str_route="規劃路線";
			if(langType=="eng"){
				str_route="Route";
			}
			if(type=='list'){
				for(var i=0;i<LP_jsonObjectArray.length;i++){
				if(nowClassify2==""||(nowClassify2!=""&&nowClassify2!=LP_jsonObjectArray[i].classify2)){
					nowClassify2=LP_jsonObjectArray[i].classify2;
					htmlResult+='<li data-role="list-divider"><span>'+LP_jsonObjectArray[i].classify2_name+'</span></li>';
				}
				htmlResult+="<li data-latitude='"+LP_jsonObjectArray[i].latitude+"' data-longitude='"+LP_jsonObjectArray[i].longitude+"' data-spotno='"+LP_jsonObjectArray[i].spotNo+"'>"+
				"<div class='image'><img src='"+LP_jsonObjectArray[i].ximage+"'></div>"+
				"<h2>"+LP_jsonObjectArray[i].chtName+"</h2>"+
				"<p>"+LP_jsonObjectArray[i].chtAddress+"</p>"+
			    "<div class='btnbox'><input type='submit' data-role='none' data-xicon='"+LP_jsonObjectArray[i].xicon+"' data-ximage='"+LP_jsonObjectArray[i].ximage+"' data-title='"+LP_jsonObjectArray[i].chtName+"' data-address='"+LP_jsonObjectArray[i].chtAddress+"'  data-latitude='"+LP_jsonObjectArray[i].latitude+"' data-longitude='"+LP_jsonObjectArray[i].longitude+"' data-spotno='"+LP_jsonObjectArray[i].spotNo+"' value='"+str_route+"' class='btnDoRoute_dataList btn06'></div>"+
				"</li>";
				}
				$('#Map_LP').find('#dataList').html("<ul data-role='none'>"+htmlResult+"</ul><div style='height:100px;width:100%'></div>");
				$('#Map_LP').find('#dataMap').hide();
				$('#Map_LP').find('#dataList').show();
				$('#Map_LP').find('#btnMAPShow').removeClass('listbtn03').addClass('listbtn01');
				$('#Map_LP').find('#btnListShow').removeClass('listbtn04').addClass('listbtn02');
			}else
			{
				$('#Map_LP').find('#dataList').hide();
				$('#Map_LP #dataMap .subDiv').hide();
				// $('#routeList').hide();
				$('#Map_LP').find('#dataMap').show();
				$('#Map_LP').find('#btnMAPShow').removeClass('listbtn01').addClass('listbtn03');
				$('#Map_LP').find('#btnListShow').removeClass('listbtn02').addClass('listbtn04');
				//重整地圖尺寸跟地圖調整中心	
				map.refresh();
			}
		    return htmlResult;
		}
		function genMapShowContent(){
			var LBSCenterLatLng=null;
 			if(typeof(map)!="undefined"&&typeof(map.LBSCenterLatLng)!=="undefined"&&map.LBSCenterLatLng!=null){
 				LBSCenterLatLng=map.LBSCenterLatLng;
 			}
			map=new HyMap();
 			map.ini(document.getElementById('map_canvas'),new google.maps.LatLng(getGPRSData().lat,getGPRSData().lng),14);
 			//設定目的地與地圖顯示中心
 			if(LBSCenterLatLng!=null){
 				map.setLBSCenterLatLng(LBSCenterLatLng,true);
 			}
 			map.setDivDirectionDetail($('#Map_LP #directions'));
		}
		function convertToGMAPMarkers(){
			//地圖初始化
			genMapShowContent();
			switchLPShowType("map"); 
			//呈現LBS中心點位置
			map.showLBSCenterMarker();
			var nearAlertSpotListHtmlResult="";
			var str_ok="確定";
			var str_cancel="取消";
			if(langType!="ch"){
				str_ok="OK";
				str_cancel="Cancel";
			}
			for(var i=0;i<LP_jsonObjectArray.length;i++){
				//gmap marker
				var title=LP_jsonObjectArray[i].chtName;
				var address=LP_jsonObjectArray[i].chtAddress;
				var latitude=LP_jsonObjectArray[i].latitude;
				var longitude=LP_jsonObjectArray[i].longitude;
				var spotNo=LP_jsonObjectArray[i].spotNo;
				var ximage=LP_jsonObjectArray[i].ximage;//待續
				var xicon=LP_jsonObjectArray[i].xicon;//待續
				map.addAdvMarker(title,address,latitude,longitude,spotNo,ximage,xicon);
				console.log(latitude+"	"+longitude);
				//nearAlertSpotList
			    nearAlertSpotListHtmlResult+='<input type="radio" id="radio_nearAlertSpot_'+i+'" name="radio_nearAlertSpotList" data-spotno="'+spotNo+'" data-latitude="'+latitude+'" data-longitude="'+longitude+'" data-title="'+title+'" data-address="'+address+'" data-theme="c">'+'<label for="radio_nearAlertSpot_'+i+'">'+title+'</label>';
			}
			if(nearAlertSpotListHtmlResult!=""){
				nearAlertSpotListHtmlResult+='<div data-role="controlgroup" data-type="horizontal"><a data-theme="c" data-role="button" data-rel="back">'+str_cancel+'</a><a data-theme="f" href="javascript:setNearAlertByList();" data-role="button">'+str_ok+'</a></div>';
			}
			$('#nearAlertSpotList').html(nearAlertSpotListHtmlResult).trigger('create');
		}
		function switchFooterFunction(type){
			if(type=='route'){
				$('.defaultFootFunction').hide();
				$('.RouteFootFunction').show();
				switchRouteShowType('map');
			}else{
				$('.defaultFootFunction').show();
				$('.RouteFootFunction').hide();
				switchLPShowType('map');
			}
		}
		function showMapSubDiv(subDiv){
			var isShow=$(subDiv).is(":visible");
			switchLPShowType('map');
			isShow==true?$(subDiv).hide():$(subDiv).show();
		}
		function setNearAlertByList(){
			var obj=$("#nearAlertSpotList input[type=radio]:checked");
			$('#popupDialog_setAlert').popup('close');
			if(typeof(obj)!="undefined"){
				doSetNearAlertSpot($(obj).data('spotNo'),$(obj).data('title'),$(obj).data('address'),$(obj).data('latitude'),$(obj).data('longitude'));
			}else{
				if(langType!="eng"){
					smoke.alert(nearAlertString_notCheckedBeforeSendFromList,{},function(){});
				}else{
					smoke.alert(nearAlertString_notCheckedBeforeSendFromList_eng,{},function(){});
				}
			}
		}
		function doSetNearAlertSpot(spotNo,title,address,latitude,longitude){
			var content="";
			if(map.nearAlertSpot!=null){
				if(latitude==map.nearAlertSpot.latitude$$longitude==map.nearAlertSpot.longitude){
					if(langType!="eng"){
						smoke.alert(nearAlertString_already,{},function(){});
					}else{
						smoke.alert(nearAlertString_already_eng,{},function(){});
					}
				}else{
					if(langType!="eng"){
						content+="已經有設定接近提醒:"+map.nearAlertSpot.title+"<br/>"+
							 	 "地址:"+(typeof(map.nearAlertSpot.address)!=='undefined'?map.nearAlertSpot.address+"("+map.nearAlertSpot.latitude+","+map.nearAlertSpot.longitude+")":map.nearAlertSpot.latitude+","+map.nearAlertSpot.longitude)+",是否替換設定?";
						smoke.confirm(content,function(e){
							if (e){
								//設定接近提醒點
								map.setNearAlertSpot({"spotNo":spotNo,"title":title,"address":address,"latitude":latitude,"longitude":longitude});
								smoke.alert(SettingOKString);
							}
						},{ok:"確定", cancel:"取消"});
					}else{
						content+="The notification has been set:"+map.nearAlertSpot.title+"<br/>"+
							 	 "ADD:"+(typeof(map.nearAlertSpot.address)!=='undefined'?map.nearAlertSpot.address+"("+map.nearAlertSpot.latitude+","+map.nearAlertSpot.longitude+")":map.nearAlertSpot.latitude+","+map.nearAlertSpot.longitude)+",Would you like to change the setting of notification?";
						smoke.confirm(content,function(e){
							if (e){
								//設定接近提醒點
								map.setNearAlertSpot({"spotNo":spotNo,"title":title,"address":address,"latitude":latitude,"longitude":longitude});
								smoke.alert(SettingOKString_eng);
							}
						},{ok:"OK", cancel:"Cancel"});
					}
				}
			}else{
				//設定接近提醒點
				map.setNearAlertSpot({"spotNo":spotNo,"title":title,"address":address,"latitude":latitude,"longitude":longitude});
				if(langType!="eng"){
					smoke.alert(SettingOKString);
				}else{
					smoke.alert(SettingOKString_eng);
				}
			}	
		}
		//pageinit
		$(document).on('pageinit','#Map_LP',function(){	
			//調整map高度
			var mheight=(window.innerHeight-80)*0.9;
			$('#map_canvas').css('height',mheight);
			//產生gmap
			genMapShowContent();
			//Filter
			genClassify1List();
			//各分類
			$(this).on('collapse',"div[data-role=collapsible]",function(){
				var divList=$('div[data-role=collapsible]');
				var itemCount=0;
				for(var i=0;i<divList.length;i++){
					if($(divList[i]).css("display")=="block"){
						itemCount++;
					}
				}
				if(itemCount==1){
					if($(this).css("display")=="none"){
						$("#topFunc").css("display","none");
					}else{
						$("#topFunc").css("display","block");
					}
				}else if(itemCount>1){
					//目前這段有重復的問題未來應該可以改善
					if($(this).css("display")=="block"){
						$("#topFunc").css("display","block");
					}else{
						$("#topFunc").css("display","none");
					}
				}
			});
			//各項目
			$(this).find('#dataList').on('click','li[data-role!="list-divider"]',function(evt){
				if ($(evt.target).is("li")) {
	 				var spotNo=$(this).data("spotno");
	 				changeToMap_CP(spotNo);
	 			}
 			});
 			//切換地圖顯示
			$(this).on('click','#btnMAPShow',function(){	
				convertToGMAPMarkers();
				$(this).removeClass('listbtn01').addClass('listbtn03');
				$('#Map_LP').find('#btnListShow').removeClass('listbtn02').addClass('listbtn04');
				//重設地圖中心
		      	map.map.setCenter(new google.maps.LatLng(getGPRSData().lat,getGPRSData().lng));
			});
 			//切換條列顯示
			$(this).on('click','#btnListShow',function(){	
				switchLPShowType("list");
				$(this).removeClass('listbtn04').addClass('listbtn02');
				$('#Map_LP').find('#btnMAPShow').removeClass('listbtn03').addClass('listbtn01');
			});
			//切換地圖導引
			$(this).on('click','#btnRoute_MAPShow',function(){	
				switchRouteShowType('map');
			});
			//切換條列導引
			$(this).on('click','#btnRoute_PathShow',function(){	
				switchRouteShowType('path');
			});
 			//查詢關鍵字查地圖
			$(this).on('click','#btnSearch',function(){
				showMapSubDiv($('#Map_LP #divKeyWordSearch'));
			});
			//路線規劃地圖
			$(this).on('click','#btnRoute',function(){
				//地址反查
				map.getAddressByLatLng(new google.maps.LatLng(getGPRSData().lat,getGPRSData().lng),$('#Map_LP').find('#txtRoutePointStart'));
				//切換FooterFunction
				showMapSubDiv($('#Map_LP #divRoutePath'));
			});
			$(this).on('click','#btnKeyWordSearch',function(){
				switchFooterFunction('default');
				map.doSearchByAddress($('#txtSearchKeyWord').val());
			});
			$(this).on('click','#btnDoRoute',function(){
				//關閉幕前顯示div
				$('#Map_LP #dataMap .subDiv').hide();
				switchFooterFunction('route');
				map.doRoutePath($('#txtRoutePointStart').val(), $('#txtRoutePointEnd').val());
			});
			$(this).on('click','#btnDoRoute_InfoWindow',function(){
				var rootElement=$(this);
				//關閉幕前顯示div
				$('#Map_LP #dataMap .subDiv').hide();
				switchFooterFunction('route');
				var title=$(this).data('title');
 				var latitude=$(this).data('latitude');
 				var longitude=$(this).data('longitude');
 				var spotNo=$(this).data('spotno');
 				var address=$(this).data('address');
 				var ximage=$(this).data('ximage');
 				var xicon=$(this).data('xicon');
 				var jsonObject={"title":title,"address":address,"latitude":latitude,"longitude":longitude,"spotNo":spotNo,"ximage":ximage,"xicon":xicon};
				map.doRoutePath(new google.maps.LatLng(getGPRSData().lat,getGPRSData().lng),new google.maps.LatLng($(rootElement).data('latitude'),$(rootElement).data('longitude')),null,jsonObject);
 				title=null;latitude=null;longitude=null;lbs=null;address=null;ximage=null;xicon=null;jsonObject=null;
 				delete title;delete latitude;delete longitude;delete lbs;delete address;delete ximage;delete xicon;delete jsonObject;
			});
			$(this).on('click','input.btnDoRoute_dataList',function(){
				var rootElement=$(this);
				switchLPShowType("map");
				$('#Map_LP').find('#btnMAPShow').removeClass('listbtn01').addClass('listbtn03');
				$('#Map_LP').find('#btnListShow').removeClass('listbtn02').addClass('listbtn04');
				//關閉幕前顯示div
				$('#Map_LP #dataMap .subDiv').hide();
				switchFooterFunction('route');
				var title=$(this).data('title');
 				var latitude=$(this).data('latitude');
 				var longitude=$(this).data('longitude');
 				var spotNo=$(this).data('spotno');
 				var address=$(this).data('address');
 				var ximage=$(this).data('ximage');
 				var xicon=$(this).data('xicon');
 				var jsonObject={"title":title,"address":address,"latitude":latitude,"longitude":longitude,"spotNo":spotNo,"ximage":ximage,"xicon":xicon};
				map.doRoutePath(new google.maps.LatLng(getGPRSData().lat,getGPRSData().lng),new google.maps.LatLng($(rootElement).data('latitude'),$(rootElement).data('longitude')),null,jsonObject);
 				title=null;latitude=null;longitude=null;lbs=null;address=null;ximage=null;xicon=null;jsonObject=null;
 				delete title;delete latitude;delete longitude;delete lbs;delete address;delete ximage;delete xicon;delete jsonObject;
			});
			$(this).on('click','#btnLBSCP',function(){
				var spotNo=$(this).data('spotno');
				if(spotNo!=""){
					changeToMap_CP(spotNo);
				}
			});
			$(this).on('click','#btnSetNearAlert',function(){
				var spotNo=$(this).data('spotNo');
				var title=$(this).data('title');
				var address=$(this).data('address');
				var latitude=$(this).data('latitude');
				var longitude=$(this).data('longitude');
				doSetNearAlertSpot(spotNo,title,address,latitude,longitude);
			});
		});
		$(document).on('pageinit','#Map_CP',function(){	
 			//地圖按鈕
 			$(this).on('click','#btnMap',function(){
 				var title=$(this).data('title');
 				var latitude=$(this).data('latitude');
 				var longitude=$(this).data('longitude');
 				var spotNo=$(this).data('spotno');
 				var address=$(this).data('address');
 				var ximage=$(this).data('ximage');
 				var xicon=$(this).data('xicon');
 				//呈現當前坐標內容
 				map.showTargetMarker(title,address,latitude,longitude,spotNo,ximage,xicon);
 				$.mobile.changePage('#Map_LP');
 				switchLPShowType("map");
 				title=null;latitude=null;longitude=null;lbs=null;address=null;ximage=null;xicon=null;
 				delete title;delete latitude;delete longitude;delete lbs;delete address;delete ximage;delete xicon;
 			});
 			//導航按鈕
			$(this).on('click','#btnRoute',function(){
				var rootElement=$(this);
				switchLPShowType("map");
				$('#Map_LP').find('#btnMAPShow').removeClass('listbtn01').addClass('listbtn03');
				$('#Map_LP').find('#btnListShow').removeClass('listbtn02').addClass('listbtn04');
				//關閉幕前顯示div
				$('#Map_LP #dataMap .subDiv').hide();
				switchFooterFunction('route');
				map.doRoutePath(new google.maps.LatLng(getGPRSData().lat,getGPRSData().lng),new google.maps.LatLng($(rootElement).data('latitude'),$(rootElement).data('longitude')));			
				$.mobile.changePage('#Map_LP');
			});
 			//電話按扭
 			$(this).on('click','#btnTel',function(){
 				var tel=$(this).data('tel');
 				if(typeof(tel)!="undefined"&&tel!=""){
	 				window.location.href="tel:"+numberFilter(tel);
	 			}else{
	 				if(langType!='eng'){
	 					smoke.alert("無電話資訊",{},function(){});
	 				}else{
		 				smoke.alert("No Service Number",{},function(){});
		 			}
	 			}
	 			tel=null;
	 			delete tel;
 			});
		});
		//pageshow
		$(document).on('pageshow','#Map_LP',function(){
			//switchFooterFunction('default');
			var mapData=getMapData();
			if(typeof(mapData)!=="undefined"&&mapData!=null){
				//關閉幕前顯示div
				$('#Map_LP #dataMap .subDiv').hide();
				switch(mapData.method){
					case "route":
						switchFooterFunction('route');
					break;
				}
				//HyMap載入mapData資料
				map.loadMapData();
			}
			//重整地圖尺寸跟地圖調整中心	
			map.refresh();
			//取消事件
			$("#Map_LP .Collapsible_Classify1").off( "expand", function(){});
			$("#Map_LP .Collapsible_Classify1").off( "collapse", function(){});
			//註冊事件
			$("#Map_LP .Collapsible_Classify1").on( "expand", function() {
				Target_Collapsible_Classify1_ID=$(this).attr('id');
				$('#Map_LP .Collapsible_Classify1').hide();
				$(this).show();
			});
			$("#Map_LP .Collapsible_Classify1").on( "collapse", function() {
				if($(this).attr('id')==Target_Collapsible_Classify1_ID){
					$('#Map_LP .Collapsible_Classify1').show();
					$('#classify1List input[type=checkbox]:checked').attr('checked','checked');
					$('#classify1List').trigger('create');
				}
			});
		});
		</script>
			<div data-role="header" data-position="fixed" data-fullscreen="false"  data-theme="f">
		     	<a href="#menu" data-role="none" class="btnMenu"></a>
                <h1>訊息與活動</h1>
		     	<div data-role="controlgroup" data-type="horizontal" class="ui-btn-right" data-mini="true">
		     		<a href="javascript:doRefresh(langType,tmpTypeCode,tmpCatalog,tmpUnit,tmpKeyWord,tmpBeginDate,tmpEndDate,tmpOrderBys,tmpCount,tmpIndex);"><img src="img/NSC/refresh.png" alt="重新整理"></a>
<!-- 		     		<a data-transition="pop" data-rel="popup" data-position-to="window"  href="#popupDialog_advSearch"><img src="img/NSC/search.png" alt="查詢"></a> -->
		     	</div>
		     	 <div id="sub-menu" style="overflow:auto"></div>
            </div>
			<div data-role="content" style="padding:0" id="content" data-iscroll="enable">
			  	<!--toplist Start-->
			  	<!-- <div id="sub-menu" style="overflow:auto"></div> -->
			  	<!--toplist end-->
				<div class="list2" id="htmlResult">
				</div>
			</div>
			<div data-theme="f" id="footerTool" data-role="footer" data-position="fixed" data-fullscreen="false">		
			  <div data-role="navbar">
			    <ul>
			      <li class="navli"><a data-rel="popup" data-position-to="window" href="#popupDialog_catalog" data-transition="pop">訊息分類</a></li>
			      <li class="navli"><a data-rel="popup" data-position-to="window" href="#popupDialog_unit" data-transition="pop">發佈組室</a></li>
			      <li class="navli"><a data-rel="popup" data-position-to="window" href="#popupDialog_titleSearch" data-transition="pop">標題搜索</a></li>
  			      <li class="navli"><a data-rel="popup" data-position-to="window" href="#popupDialog_dateRange" data-transition="pop">發佈日期</a></li>
			    </ul>
			  </div>
			</div>
			<!--popup-->
			<div data-role="popup" id="popupDialog_advSearch" data-overlay-theme="a" data-theme="a" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
    			<div id="advSearch">	
    				<label for="catalog">分類:</label>
    				<select data-theme="c" id="adv_catalog"></select>
    				<label for="unit">組室別:</label>
    				<select data-theme="c" id="adv_unit"></select>
    				<label for="keyword">關鍵字:</label>
    				<input data-theme="c" type="search" id="adv_keyword" value="" placeholder="請輸入關鍵字..."></input>
    				<label for="dateRange">發佈日期:</label>
    				<div data-role="controlgroup" data-type="horizontal">
					<label for="dateRange">起:</label><input type="date" id="beginDate">
					</div>
					至
					<div data-role="controlgroup" data-type="horizontal">
    				迄日:<input type="date" id="endDate">
	    			</div>
    				<label for="typeCode">排序方式:</label>
    				<select  data-theme="c"  id="adv_sortBy">
    					<option value="01">更新日期</option>
    					<option value="02">點閱次數</option>
    				</select>
    				<a data-theme="f" href="javascript:setAdvSearch();" href="#LP_temp" data-role="button">查詢</a>
		    	</div>
			</div>
			<div data-role="popup" id="popupDialog_catalog" data-overlay-theme="a" data-theme="a" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
				<div style="text-align:center;padding:25px">
					<div style="text-align:right"><a class="popupCloseBtn" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" style="position:absolute;top: -5px;left:-10px;">關閉</a></div>
	    			<div style="text-align:center;" id="catalogList">	
			    	</div>
			    </div>
			</div>
			<div data-role="popup" id="popupDialog_unit" data-overlay-theme="a" data-theme="a" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
				<div style="text-align:center;padding:25px">
					<div style="text-align:right"><a class="popupCloseBtn" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" style="position:absolute;top: -5px;left:-10px;">關閉</a></div>
	    			<div style="text-align:center;" id="unitList">	
			    	</div>
			    </div>
			</div>
			<div data-role="popup" id="popupDialog_titleSearch" data-overlay-theme="a" data-theme="a" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
				<div style="text-align:center;padding:25px">
					<div style="text-align:right"><a class="popupCloseBtn" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" style="position:absolute;top: -5px;left:-10px;">關閉</a></div>
	    			<div style="text-align:center;" id="titleSearch">	
	    				<input type="search" id="search" value="" placeholder="請輸入關鍵字...">
	    				<a data-theme="c" onclick="javascript:setKeyword();" data-role="button">查詢</a>
			    	</div>
			    </div>
			</div>
			<div data-role="popup" id="popupDialog_dateRange" data-overlay-theme="a" data-theme="a" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
				<div style="text-align:center;padding:25px">
					<div style="text-align:right"><a class="popupCloseBtn" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" style="position:absolute;top: -5px;left:-10px;">關閉</a></div>
	    			<div id="dateRange">	
	    				<label for="dateRange">發佈日期:</label>
	    				<div data-role="controlgroup" data-type="horizontal">
						起日:<input  type="date" id="beginDate">
						</div>
						<div data-role="controlgroup" data-type="horizontal">
	    				迄日:<input type="date" id="endDate">
		    			</div>
	    					<a data-theme="c" href="javascript:setDateRange();" data-role="button">查詢</a>
			    	</div>
			    </div>
			</div>
		</div>
		<div data-role="page" id="CP">
			<div data-role="header" data-position="fixed" data-fullscreen="false"  data-theme="f">
				<a data-rel="back" data-icon="arrow-l">返回</a>
                <h1>訊息與活動</h1>
            </div>
			<div data-role="content" style="padding:0" id="content" >
				<div id="htmlResult">
				</div>
			</div>
		</div>
		<div data-role="page" id="LP_temp">
			loading...
        </div>
		<!--地圖模組-->
		<div data-role="page" id="Map_LP">
			<div data-role="header" data-position="fixed" data-fullscreen="false" data-theme="f">
				<a data-rel="back" class="btn_back" data-icon="arrow-l">返回</a>
		     	<!-- <a href="#index" data-icon="arrow-l">返回</a> -->
                <h1 class="page_title">生活服務</h1>
            </div>
			<div data-role="content" style="padding:0" id="content">
				<div id='dataMap' class='acenter'>
					<!-- keyWordSearch -->
					<div id='divKeyWordSearch' class='subDiv'>
						<input data-role='none' type='text' class='search' id='txtSearchKeyWord' placeholder='地址/地名/廠商名稱'>
						<a id='btnKeyWordSearch'   data-mini="true" data-inline="true" data-role="button" data-theme="e">查詢</a>
					</div>
					<!-- RountePath -->
					<div id='divRoutePath' class='subDiv aleft2'>
						<div data-role="fieldcotain">
							<label id="labRoutePointStart" for='txtRoutePointStart'>起點：</label>
							<input type='text'  id='txtRoutePointStart' placeholder='地址/地名/廠商名稱'>
						</div>
						<div data-role="fieldcotain">
							<label id="labRoutePointEnd" for='txtRoutePointEnd'>終點：</label>
							<input type='text' id='txtRoutePointEnd' placeholder='地址/地名/廠商名稱'>
						</div>
						<div class="acenter"><button data-icon="search"  data-mini="true" data-inline="true" data-theme="e" id='btnDoRoute'>路徑規劃</button></div>
					</div>
					<!-- map -->
					<div id='map_canvas' style='width:100%;height:290px;'></div>
					<div id="routeList" class="ui-listview ui-listview-inset ui-corner-all ui-shadow" style="display:none;">
						<div id="divDirectionHeader" class="ui-li ui-li-divider ui-btn ui-bar-b ui-corner-top ui-btn-up-undefined">規劃路徑</div>
						<div id="directions" class='acenter gmapDirections'></div>
						<div class="ui-li ui-li-divider ui-btn ui-bar-b ui-corner-bottom ui-btn-up-undefined"></div>
						<!-- 撐高用的 -->	
						<div style="height:80px;"></div>
					</div>
				</div>
				<div class='list' id='dataList'></div>
			</div>
			<div data-theme="f" data-role="footer" data-position="fixed" data-fullscreen="false">	
				<div id="footer">
					<div class="footbtn">
						<ul data-role="none">
							<li><a data-role="none" id="btnMAPShow" class="defaultFootFunction listbtn03">地圖呈現</a></li>
							<li><a data-role="none" id="btnListShow" class="defaultFootFunction listbtn04">圖文並列</a></li>
							<li><a data-role="none" style="display:none;" id="btnRoute_MAPShow" class="RouteFootFunction listbtn03">地圖導引</a></li>
							<li><a data-role="none" style="display:none;" id="btnRoute_PathShow" class="RouteFootFunction listbtn04">文字導引</a></li>
						</ul>
					</div>
					<div class="function">
						<ul data-role="none">
							<li><a data-role="none" id="btnSearch" class="f1">搜尋地圖</a></li>
							<li><a data-role="none" id="btnRoute" class="f2">規劃路線</a></li>
							<li><a data-role="none" data-rel="popup" data-position-to="window" href="#popupDialog_classify1Filter" data-transition="pop" id="btnClassify1Filter" class="f3">週邊生活服務</a></li>
							<li><a data-rel="popup" data-position-to="window" href="#popupDialog_setAlert" data-transition="pop" data-role="none" id="btnSetAlert" class="f4">接近提醒</a></li>
						</ul>
					</div>
				</div>
			</div>
			<!--popup-->
			<div data-role="popup" id="popupDialog_classify1Filter" data-overlay-theme="a" data-theme="a" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
    			<div style="text-align:center;padding:25px" id="classify1List" class="ui-content">	
		    	</div>
			</div>
			<div data-role="popup" id="popupDialog_setAlert" data-overlay-theme="a" data-theme="a" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
    			<div style="text-align:center;" id="nearAlertSpotList">	
		    	</div>
			</div>
		</div>
		<div data-role="page" id="Map_CP">
			<div data-role="header" data-position="fixed" data-fullscreen="false" data-theme="f">
				<a data-rel="back" class="btn_back" data-icon="arrow-l">返回</a>
                <h1 class="page_title">生活服務</h1>
            </div>
			<div data-role="content" style="padding:0" id="content">
			</div>
		</div>
	</body>
</html>